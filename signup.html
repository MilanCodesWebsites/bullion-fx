<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
      (function() {
        emailjs.init("hecBDI4InGk7Ycg0D");
      })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BullionFX | Sign Up</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="signup.css">
    <link rel="stylesheet" href="loading.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="translate.css">
    <style>
        /* OTP Modal Styles */
        .otp-modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.85);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.3s ease, visibility 0.3s ease;
          backdrop-filter: blur(5px);
        }

        .otp-modal-overlay.active {
          opacity: 1;
          visibility: visible;
        }

        .otp-modal {
          background-color: #1a1a1a;
          border-radius: 20px;
          padding: 30px;
          width: 90%;
          max-width: 400px;
          border: 1px solid #333;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
          transform: translateY(-20px);
          transition: transform 0.3s ease;
          position: relative;
        }

        .otp-modal-overlay.active .otp-modal {
          transform: translateY(0);
        }

        .otp-close-btn {
          position: absolute;
          top: 15px;
          right: 15px;
          background: none;
          border: none;
          color: rgba(255, 255, 255, 0.5);
          font-size: 20px;
          cursor: pointer;
          transition: color 0.3s ease;
        }

        .otp-close-btn:hover {
          color: #fff;
        }

        .otp-modal-header {
          text-align: center;
          margin-bottom: 20px;
        }

        .otp-modal-title {
          color: #fff;
          font-size: 24px;
          font-weight: 600;
          margin-bottom: 10px;
        }

        .otp-modal-message {
          color: rgba(255, 255, 255, 0.8);
          font-size: 14px;
          line-height: 1.5;
        }

        .otp-email-highlight {
          color: #007BFF;
          font-weight: 600;
        }

        .otp-input-container {
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-bottom: 20px;
        }

        .otp-input {
          width: 45px;
          height: 45px;
          border: 2px solid #333;
          border-radius: 8px;
          background-color: #2a2a2a;
          color: #fff;
          text-align: center;
          font-size: 18px;
          font-weight: 600;
          transition: border-color 0.3s ease;
        }

        .otp-input:focus {
          outline: none;
          border-color: #007BFF;
        }

        .otp-input.error {
          border-color: #ef4444;
          animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }

        .otp-timer-container {
          margin-bottom: 20px;
        }

        .otp-timer-text {
          display: flex;
          justify-content: space-between;
          color: rgba(255, 255, 255, 0.8);
          font-size: 14px;
          margin-bottom: 8px;
        }

        .otp-timer-bar {
          width: 100%;
          height: 4px;
          background-color: #333;
          border-radius: 2px;
          overflow: hidden;
        }

        .otp-timer-progress {
          height: 100%;
          background-color: #007BFF;
          transition: width 1s linear;
        }

        .otp-error {
          color: #ef4444;
          font-size: 14px;
          text-align: center;
          margin-bottom: 15px;
          min-height: 20px;
        }

        .otp-error.success {
          color: #10b981; /* Green color for successful verification */
        }

        .otp-verify-button {
          width: 100%;
          padding: 12px;
          background-color: #007BFF;
          color: #fff;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: background-color 0.3s ease;
          margin-bottom: 15px;
        }

        .otp-verify-button:hover:not(:disabled) {
          background-color: #0657ad;
        }

        .otp-verify-button:disabled {
          background-color: #374151;
          cursor: not-allowed;
        }

        .otp-resend {
          text-align: center;
        }

        .otp-resend-button {
          background: none;
          border: none;
          color: #007BFF;
          font-size: 14px;
          cursor: pointer;
          text-decoration: underline;
          transition: color 0.3s ease;
        }

        .otp-resend-button:hover:not(:disabled) {
          color: #4338ca;
        }

        .otp-resend-button:disabled {
          color: #6b7280;
          cursor: not-allowed;
          text-decoration: none;
        }

        .otp-loading {
          display: inline-block;
          width: 12px;
          height: 12px;
          border: 2px solid #333;
          border-top: 2px solid #007BFF;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* Toast Notification Styles */
        .toast {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background-color: #ef4444;
          color: #fff;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          z-index: 2000;
          opacity: 0;
          transform: translateY(20px);
          transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .toast.show {
          opacity: 1;
          transform: translateY(0);
        }

         
    </style>
</head>
<body>
     <div class="translate-cont">
        <button class="toggle-button" onclick="toggleDiv()">Translate</button>
    </div>
            <div class="gtranslate_wrapper toggle-div" id="myDiv"></div>
<script>window.gtranslateSettings = {"default_language":"en","wrapper_selector":".gtranslate_wrapper","switcher_vertical_position":"top","float_switcher_open_direction":"bottom"}</script>
<script src="https://cdn.gtranslate.net/widgets/latest/float.js" defer></script>
    
    <script>
        function toggleDiv() {
            const div = document.getElementById('myDiv');
            div.classList.toggle('show');
        }
    </script>
    <div class="loading-screen">
        <img src="bull.gif" alt="Bull Running" class="bull-gif" />
        <div class="progress-track">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
    </div>
    <div class="main-app-container" id="main-app-container">
    <nav class="navbar-container">
        <a href="index.html" class="navbar-logo">bullionfx.</a>
        <div class="hamburger-menu" id="hamburgerMenu">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <ul class="navbar-links-desktop" id="navbarLinksDesktop">
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="features.html">Features</a></li>
        </ul>
        <div class="navbar-auth-desktop" id="navbarAuthDesktop">
            <a href="signup.html"><button class="signup-btn">Sign Up</button></a>
            <a href="login.html"><button class="login-btn">Login</button></a>
        </div>
        <div class="mobile-menu-content" id="mobileMenuContent">
            <ul class="navbar-links-mobile">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="features.html">Features</a></li>
            </ul>
            <div class="navbar-auth-mobile">
                <a href="signup.html"><button class="signup-btn">Sign Up</button></a>
                <a href="login.html"><button class="login-btn">Login</button></a>
            </div>
        </div>
    </nav>
    <main>
        <div class="outer">
            <div class="inner">
                <div class="titanvault-register">
                    <div class="logo-ii">
                        <i data-lucide="shield"></i>
                    </div>
                    <h1 class="title">Create your BullionFX account</h1>
                    <p class="subtitle">Join millions who trust BullionFX for secure crypto trading</p>
                    <div class="error-message" id="registerErrorMessage"></div>
                    <form id="registerForm" onsubmit="handleRegister(event)">
                        <div class="form-group">
                            <div class="form-row">
                                <div>
                                    <label class="form-label" for="registerFirstName">First Name</label>
                                    <div class="input-wrapper">
                                        <i data-lucide="user" class="input-icon"></i>
                                        <input 
                                            type="text" 
                                            id="registerFirstName" 
                                            name="firstname"
                                            class="form-input" 
                                            placeholder="John"
                                            required
                                        >
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label" for="registerLastName">Last Name</label>
                                    <div class="input-wrapper">
                                        <i data-lucide="user" class="input-icon"></i>
                                        <input 
                                            type="text" 
                                            id="registerLastName" 
                                            name="lastname"
                                            class="form-input" 
                                            placeholder="Doe"
                                            required
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="registerEmail">Email Address</label>
                            <div class="input-wrapper">
                                <i data-lucide="mail" class="input-icon"></i>
                                <input 
                                    type="email" 
                                    id="registerEmail" 
                                    name="email"
                                    class="form-input" 
                                    placeholder="john@example.com"
                                    required
                                >
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="registerPassword">Password</label>
                            <div class="input-wrapper">
                                <i data-lucide="lock" class="input-icon"></i>
                                <input 
                                    type="password" 
                                    id="registerPassword" 
                                    name="password"
                                    class="form-input" 
                                    placeholder="Create a strong password"
                                    required
                                >
                                <button type="button" class="password-toggle" id="registerPasswordToggle">
                                    <i data-lucide="eye-off"></i>
                                </button>
                            </div>
                            <div class="password-strength" id="registerPasswordStrength" style="display: none;">
                                <div class="strength-bar">
                                    <div class="strength-fill" id="registerStrengthFill"></div>
                                </div>
                                <div class="strength-text" id="registerStrengthText"></div>
                                <div class="strength-requirements">
                                    <div class="requirement" id="register-req-length">
                                        <span>✗</span>
                                        <span>At least 8 characters</span>
                                    </div>
                                    <div class="requirement" id="register-req-upper">
                                        <span>✗</span>
                                        <span>One uppercase letter</span>
                                    </div>
                                    <div class="requirement" id="register-req-lower">
                                        <span>✗</span>
                                        <span>One lowercase letter</span>
                                    </div>
                                    <div class="requirement" id="register-req-number">
                                        <span>✗</span>
                                        <span>One number</span>
                                    </div>
                                    <div class="requirement" id="register-req-special">
                                        <span>✗</span>
                                        <span>One special character</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="registerConfirmPassword">Confirm Password</label>
                            <div class="input-wrapper">
                                <i data-lucide="lock" class="input-icon"></i>
                                <input 
                                    type="password" 
                                    id="registerConfirmPassword" 
                                    name="confirm_password"
                                    class="form-input" 
                                    placeholder="Confirm your password"
                                    required
                                >
                                <button type="button" class="password-toggle" id="registerConfirmPasswordToggle">
                                    <i data-lucide="eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="registerTerms" class="checkbox" required>
                            <label for="registerTerms" class="checkbox-label">
                                I agree to the <a href="terms.html" target="_blank">Terms of Service</a> and <a href="privacy.html" target="_blank">Privacy Policy</a>
                            </label>
                        </div>
                        <button type="submit" class="submit-btn" id="registerSubmitBtn" disabled>Create Account</button>
                    </form>
                    <div class="auth-link">
                        Already have an account? <a href="#" onclick="showLoginForm()">Sign in</a>
                    </div>
                    <p class="security-text">Your account will be protected by military-grade encryption</p>
                </div>
            </div>
        </div>
    </main>
    <div class="otp-modal-overlay" id="otpModalOverlay">
        <div class="otp-modal">
            <button class="otp-close-btn" id="otpCloseBtn">&times;</button>
            <div class="otp-modal-header">
                <div class="otp-modal-title">Verify Your Email</div>
                <div class="otp-modal-message">
                    We've sent a 6-digit verification code to <span class="otp-email-highlight" id="otpEmailDisplay"></span>. 
                    Please enter the code below to verify your account. 
                    <br><br>
                    Check your inbox and spam folder if you don't see it.
                </div>
            </div>
            <div class="otp-input-container">
                <input type="text" class="otp-input" maxlength="1" id="otp-1" inputmode="numeric" pattern="[0-9]*">
                <input type="text" class="otp-input" maxlength="1" id="otp-2" inputmode="numeric" pattern="[0-9]*">
                <input type="text" class="otp-input" maxlength="1" id="otp-3" inputmode="numeric" pattern="[0-9]*">
                <input type="text" class="otp-input" maxlength="1" id="otp-4" inputmode="numeric" pattern="[0-9]*">
                <input type="text" class="otp-input" maxlength="1" id="otp-5" inputmode="numeric" pattern="[0-9]*">
                <input type="text" class="otp-input" maxlength="1" id="otp-6" inputmode="numeric" pattern="[0-9]*">
            </div>
            <div class="otp-timer-container">
                <div class="otp-timer-text">
                    <span>OTP expires in:</span>
                    <span id="otpTimerDisplay">5:00</span>
                </div>
                <div class="otp-timer-bar">
                    <div class="otp-timer-progress" id="otpTimerProgress"></div>
                </div>
            </div>
            <div class="otp-error" id="otpError"></div>
            <button class="otp-verify-button" id="verifyButton" disabled>Verify</button>
            <div class="otp-resend">
                <button class="otp-resend-button" id="resendButton" disabled>Resend Code</button>
            </div>
        </div>
    </div>
    <footer class="bullionfx-footer">
        <div class="footer-content-wrapper">
            <div class="footer-brand">
                <div class="footer-logo">
                    <i data-lucide="gold"></i>
                    <span>BullionFX</span>
                </div>
                <p class="footer-description">
                    Leading the future of digital assets by tokenizing physical gold, offering unparalleled stability and accessibility.
                </p>
                <div class="social-links">
                    <a href="#" class="social-icon" aria-label="Twitter">
                        <i data-lucide="twitter"></i>
                    </a>
                    <a href="#" class="social-icon" aria-label="Instagram">
                        <i data-lucide="instagram"></i>
                    </a>
                    <a href="#" class="social-icon" aria-label="Facebook">
                        <i data-lucide="facebook"></i>
                    </a>
                </div>
            </div>
            <div class="footer-nav-group">
                <h3 class="nav-heading">Quick Links</h3>
                <ul class="nav-list">
                    <li class="nav-item"><a href="#" class="nav-link">Features</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Benefits</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Services</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Upgrade</a></li>
                </ul>
            </div>
            <div class="footer-nav-group">
                <h3 class="nav-heading">Legal</h3>
                <ul class="nav-list">
                    <li class="nav-item"><a href="#" class="nav-link">Terms & Conditions</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Privacy Policy</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Cookie Policy</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Disclaimer</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-copyright">
            &copy; <span id="currentYear"></span> BullionFX. All rights reserved.
        </div>
    </footer>
    </div>
    <script>
        lucide.createIcons();
    </script>
    <script src="script.js"></script>
    <script src="loading-script.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Password visibility toggles
        function setupRegisterPasswordToggle(inputId, toggleId) {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(toggleId);
            const icon = toggle.querySelector('i');

            toggle.addEventListener('click', function() {
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.setAttribute('data-lucide', 'eye-off');
                } else {
                    input.type = 'password';
                    icon.setAttribute('data-lucide', 'eye');
                }
                lucide.createIcons();
            });
        }

        setupRegisterPasswordToggle('registerPassword', 'registerPasswordToggle');
        setupRegisterPasswordToggle('registerConfirmPassword', 'registerConfirmPasswordToggle');

        // Password strength checker
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerPasswordStrength = document.getElementById('registerPasswordStrength');
        const registerStrengthFill = document.getElementById('registerStrengthFill');
        const registerStrengthText = document.getElementById('registerStrengthText');

        const registerRequirements = {
            length: { 
                element: document.getElementById('register-req-length'), 
                test: (pwd) => pwd.length >= 8 
            },
            upper: { 
                element: document.getElementById('register-req-upper'), 
                test: (pwd) => /[A-Z]/.test(pwd) 
            },
            lower: { 
                element: document.getElementById('register-req-lower'), 
                test: (pwd) => /[a-z]/.test(pwd) 
            },
            number: { 
                element: document.getElementById('register-req-number'), 
                test: (pwd) => /[0-9]/.test(pwd) 
            },
            special: { 
                element: document.getElementById('register-req-special'), 
                test: (pwd) => /[^a-zA-Z0-9]/.test(pwd) 
            }
        };

        function updateRegisterPasswordStrength(password) {
            if (password.length === 0) {
                registerPasswordStrength.style.display = 'none';
                return;
            }
            
            registerPasswordStrength.style.display = 'block';
            
            let metRequirements = 0;
            
            const requirementTexts = {
                length: 'At least 8 characters',
                upper: 'One uppercase letter',
                lower: 'One lowercase letter', 
                number: 'One number',
                special: 'One special character'
            };
            
            Object.entries(registerRequirements).forEach(([key, req]) => {
                const met = req.test(password);
                
                if (met) {
                    req.element.classList.add('met');
                    req.element.innerHTML = '<span style="color: #059669;">✓</span> <span>' + requirementTexts[key] + '</span>';
                    metRequirements++;
                } else {
                    req.element.classList.remove('met');
                    req.element.innerHTML = '<span style="color: #ef4444;">✗</span> <span>' + requirementTexts[key] + '</span>';
                }
            });
            
            const percentage = (metRequirements / 5) * 100;
            registerStrengthFill.style.width = percentage + '%';
            
            if (metRequirements <= 2) {
                registerStrengthFill.style.background = '#ef4444';
                registerStrengthText.textContent = 'Weak';
                registerStrengthText.style.color = '#ef4444';
            } else if (metRequirements <= 4) {
                registerStrengthFill.style.background = '#f59e0b';
                registerStrengthText.textContent = 'Medium';
                registerStrengthText.style.color = '#f59e0b';
            } else {
                registerStrengthFill.style.background = '#10b981';
                registerStrengthText.textContent = 'Strong';
                registerStrengthText.style.color = '#10b981';
            }
            
            updateRegisterSubmitButton();
        }

        registerPasswordInput.addEventListener('input', function() {
            updateRegisterPasswordStrength(this.value);
        });

        // Form validation
        const registerForm = document.getElementById('registerForm');
        const registerSubmitBtn = document.getElementById('registerSubmitBtn');
        const registerErrorMessage = document.getElementById('registerErrorMessage');

        function updateRegisterSubmitButton() {
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const terms = document.getElementById('registerTerms').checked;
            
            const allRequirementsMet = password.length > 0 && Object.values(registerRequirements).every(req => req.test(password));
            const passwordsMatch = password === confirmPassword && confirmPassword.length > 0;
            const allFieldsFilled = firstName && lastName && email && password && confirmPassword;
            
            registerSubmitBtn.disabled = !(allFieldsFilled && allRequirementsMet && passwordsMatch && terms);
        }

        ['registerFirstName', 'registerLastName', 'registerEmail', 'registerConfirmPassword'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateRegisterSubmitButton);
        });

        document.getElementById('registerTerms').addEventListener('change', updateRegisterSubmitButton);

        document.getElementById('registerConfirmPassword').addEventListener('input', function() {
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && password !== confirmPassword) {
                this.style.borderColor = '#ef4444';
            } else {
                this.style.borderColor = '#d1d5db';
            }
            
            updateRegisterSubmitButton();
        });

        // Toast Notification Handler
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.className = 'toast show';
            }, 100);
            
            setTimeout(() => {
                toast.className = 'toast';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Helper function for task scheduling
        function scheduleTask(callback, delay = 0) {
            if (delay > 0) {
                return setTimeout(callback, delay);
            }
            
            if (typeof requestIdleCallback !== 'undefined') {
                return requestIdleCallback(callback, { timeout: 1000 });
            } else {
                return setTimeout(callback, 0);
            }
        }

        function cancelTask(taskId) {
            if (typeof cancelIdleCallback !== 'undefined') {
                cancelIdleCallback(taskId);
            } else {
                clearTimeout(taskId);
            }
        }

        // OTP Verification Class
        class OptimizedOTPVerification {
            constructor() {
                this.otp = null;
                this.email = null;
                this.formData = null;
                this.fullname = null;
                this.timerInterval = null;
                this.remainingTime = 0;
                this.expiryTime = 300; // 5 minutes in seconds
                this.otpSentTimestamp = 0;
                this.elements = null;
                this.taskIds = [];
                
                scheduleTask(() => this.init());
            }
            
            getElements() {
                if (!this.elements) {
                    this.elements = {
                        otpModalOverlay: document.getElementById('otpModalOverlay'),
                        otpCloseBtn: document.getElementById('otpCloseBtn'),
                        otpEmailDisplay: document.getElementById('otpEmailDisplay'),
                        otpInputs: Array.from({ length: 6 }, (_, i) => document.getElementById(`otp-${i+1}`)),
                        otpTimerDisplay: document.getElementById('otpTimerDisplay'),
                        otpTimerProgress: document.getElementById('otpTimerProgress'),
                        otpError: document.getElementById('otpError'),
                        verifyButton: document.getElementById('verifyButton'),
                        resendButton: document.getElementById('resendButton')
                    };
                }
                return this.elements;
            }
            
            init() {
                const elements = this.getElements();
                
                scheduleTask(() => this.setupOTPInputs());
                
                elements.verifyButton.addEventListener('click', () => this.verifyOTP(), { passive: true });
                elements.resendButton.addEventListener('click', () => this.resendOTP(), { passive: true });
                elements.otpCloseBtn.addEventListener('click', () => this.hideModal(), { passive: true });
                
                elements.otpModalOverlay.addEventListener('click', (e) => {
                    if (e.target === elements.otpModalOverlay) {
                        this.hideModal();
                    }
                }, { passive: true });
            }
            
            setupOTPInputs() {
                const elements = this.getElements();
                
                const processInputBatch = (startIdx, batchSize) => {
                    const endIdx = Math.min(startIdx + batchSize, elements.otpInputs.length);
                    
                    for (let i = startIdx; i < endIdx; i++) {
                        const input = elements.otpInputs[i];
                        
                        input.addEventListener('input', (e) => {
                            const value = e.target.value;
                            
                            if (!/^\d*$/.test(value)) {
                                e.target.value = '';
                                return;
                            }
                            
                            if (value && i < elements.otpInputs.length - 1) {
                                elements.otpInputs[i + 1].focus();
                            }
                            
                            this.updateVerifyButtonState();
                        });
                        
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Backspace' && !e.target.value && i > 0) {
                                elements.otpInputs[i - 1].focus();
                            }
                        });
                        
                        input.addEventListener('paste', (e) => {
                            e.preventDefault();
                            const pastedData = e.clipboardData.getData('text').replace(/\D/g, '');
                            
                            for (let j = 0; j < Math.min(pastedData.length, elements.otpInputs.length - i); j++) {
                                elements.otpInputs[i + j].value = pastedData[j];
                            }
                            
                            this.updateVerifyButtonState();
                        });
                    }
                    
                    if (endIdx < elements.otpInputs.length) {
                        const taskId = scheduleTask(() => processInputBatch(endIdx, batchSize));
                        this.taskIds.push(taskId);
                    }
                };
                
                processInputBatch(0, 3);
            }
            
            updateVerifyButtonState() {
                const elements = this.getElements();
                const allFilled = elements.otpInputs.every(input => input.value.length === 1);
                elements.verifyButton.disabled = !allFilled;
            }
            
            getEnteredOTP() {
                return this.getElements().otpInputs.map(input => input.value).join('');
            }
            
            showModal(email, formData) {
                const elements = this.getElements();
                
                this.email = email;
                this.formData = formData;
                this.fullname = `${formData.get('firstname')} ${formData.get('lastname')}`;
                
                const prepareModal = () => {
                    elements.otpEmailDisplay.textContent = this.email;
                    
                    const clearInputs = (startIdx, count) => {
                        const endIdx = Math.min(startIdx + count, elements.otpInputs.length);
                        
                        for (let i = startIdx; i < endIdx; i++) {
                            elements.otpInputs[i].value = '';
                            elements.otpInputs[i].classList.remove('error');
                        }
                        
                        if (endIdx < elements.otpInputs.length) {
                            const taskId = scheduleTask(() => clearInputs(endIdx, count));
                            this.taskIds.push(taskId);
                        }
                    };
                    
                    clearInputs(0, 3);
                    elements.otpError.textContent = '';
                };
                
                const showModalAndFocus = () => {
                    elements.otpModalOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    const taskId = scheduleTask(() => {
                        elements.otpInputs[0].focus();
                    }, 300);
                    this.taskIds.push(taskId);
                };
                
                scheduleTask(() => {
                    prepareModal();
                    
                    const taskId = scheduleTask(() => {
                        this.generateAndSendOTP();
                        showModalAndFocus();
                    });
                    this.taskIds.push(taskId);
                });
            }
            
            hideModal() {
                const elements = this.getElements();
                
                elements.otpModalOverlay.classList.remove('active');
                document.body.style.overflow = '';
                
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                this.taskIds.forEach(id => cancelTask(id));
                this.taskIds = [];
            }
            
            generateAndSendOTP() {
                const elements = this.getElements();
                const now = Date.now();
                
                if (this.otpSentTimestamp && (now - this.otpSentTimestamp) < 30000) {
                    const waitTime = Math.ceil((30000 - (now - this.otpSentTimestamp)) / 1000);
                    elements.otpError.textContent = `Please wait ${waitTime} seconds before requesting a new code.`;
                    return false;
                }
                
                this.otp = Math.floor(100000 + Math.random() * 900000).toString();
                console.log('Generated OTP:', this.otp);
                
                const taskId = scheduleTask(() => this.sendOTPEmail());
                this.taskIds.push(taskId);
                
                const timerTaskId = scheduleTask(() => this.startTimer());
                this.taskIds.push(timerTaskId);
                
                this.otpSentTimestamp = now;
                elements.resendButton.disabled = true;
                
                return true;
            }
            
            sendOTPEmail() {
                const elements = this.getElements();
                
                elements.otpError.innerHTML = 'Sending verification code... <span class="otp-loading"></span>';
                
                const sendEmail = () => {
                    return new Promise((resolve, reject) => {
                        if (typeof emailjs !== 'undefined') {
                            emailjs.send(
                                "service_1jdeyps",
                                "template_tsssngx",
                                {
                                    to_name: this.fullname,
                                    to_email: this.email,
                                    otp: this.otp,
                                    message: "This is your verification code for BullionFX. It will expire in 5 minutes."
                                }
                            ).then(resolve, reject);
                        } else {
                            reject(new Error("EmailJS is not defined. Please ensure it is properly initialized."));
                        }
                    });
                };
                
                const taskId = scheduleTask(async () => {
                    try {
                        const response = await sendEmail();
                        console.log("OTP email sent successfully:", response);
                        elements.otpError.textContent = "Verification code sent successfully!";
                        
                        const clearMsgTaskId = scheduleTask(() => {
                            elements.otpError.textContent = "";
                        }, 3000);
                        this.taskIds.push(clearMsgTaskId);
                    } catch (error) {
                        console.error("Failed to send OTP email:", error);
                        elements.otpError.textContent = "Failed to send verification code. Please try again.";
                        elements.resendButton.disabled = false;
                    }
                });
                this.taskIds.push(taskId);
            }
            
            startTimer() {
                const elements = this.getElements();
                
                this.remainingTime = this.expiryTime;
                this.updateTimerDisplay();
                
                const updateTimer = () => {
                    this.remainingTime--;
                    this.updateTimerDisplay();
                    
                    const progressPercentage = (this.remainingTime / this.expiryTime) * 100;
                    elements.otpTimerProgress.style.width = progressPercentage + '%';
                    
                    if (this.remainingTime <= 0) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                        
                        const expiryTaskId = scheduleTask(() => {
                            elements.otpError.textContent = "OTP has expired. Please request a new code.";
                            elements.resendButton.disabled = false;
                            elements.verifyButton.disabled = true;
                        });
                        this.taskIds.push(expiryTaskId);
                    } else {
                        this.timerInterval = setTimeout(() => {
                            const nextUpdateTaskId = scheduleTask(updateTimer);
                            this.taskIds.push(nextUpdateTaskId);
                        }, 1000);
                    }
                };
                
                const initialTimerTaskId = scheduleTask(updateTimer);
                this.taskIds.push(initialTimerTaskId);
            }
            
            updateTimerDisplay() {
                const elements = this.getElements();
                
                const minutes = Math.floor(this.remainingTime / 60);
                const seconds = this.remainingTime % 60;
                elements.otpTimerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            resendOTP() {
                if (this.generateAndSendOTP()) {
                    const elements = this.getElements();
                    
                    elements.otpError.textContent = "A new verification code has been sent.";
                    
                    const clearInputs = (startIdx, count) => {
                        const endIdx = Math.min(startIdx + count, elements.otpInputs.length);
                        
                        for (let i = startIdx; i < endIdx; i++) {
                            elements.otpInputs[i].value = '';
                            elements.otpInputs[i].classList.remove('error');
                        }
                        
                        if (endIdx < elements.otpInputs.length) {
                            const taskId = scheduleTask(() => clearInputs(endIdx, count));
                            this.taskIds.push(taskId);
                        } else {
                            elements.otpInputs[0].focus();
                        }
                    };
                    
                    clearInputs(0, 3);
                    elements.verifyButton.disabled = true;
                }
            }
            
            verifyOTP() {
                const elements = this.getElements();
                const enteredOTP = this.getEnteredOTP();
                
                if (enteredOTP === this.otp) {
                    elements.otpError.textContent = "Verification successful!";
                    elements.otpError.classList.add('success');
                    
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                    }
                    
                    const taskId = scheduleTask(() => this.completeRegistration(), 1000);
                    this.taskIds.push(taskId);
                } else {
                    const markAndClearInputs = () => {
                        elements.otpError.textContent = "Invalid OTP. Please try again.";
                        elements.otpError.classList.remove('success');
                        
                        elements.otpInputs.forEach(input => {
                            input.classList.add('error');
                        });
                        
                        const clearTaskId = scheduleTask(() => {
                            const clearInputs = (startIdx, count) => {
                                const endIdx = Math.min(startIdx + count, elements.otpInputs.length);
                                
                                for (let i = startIdx; i < endIdx; i++) {
                                    elements.otpInputs[i].value = '';
                                    elements.otpInputs[i].classList.remove('error');
                                }
                                
                                if (endIdx < elements.otpInputs.length) {
                                    const nextBatchTaskId = scheduleTask(() => clearInputs(endIdx, count));
                                    this.taskIds.push(nextBatchTaskId);
                                } else {
                                    elements.otpInputs[0].focus();
                                    elements.verifyButton.disabled = true;
                                }
                            };
                            
                            clearInputs(0, 3);
                        }, 1000);
                        
                        this.taskIds.push(clearTaskId);
                    };
                    
                    const errorTaskId = scheduleTask(markAndClearInputs);
                    this.taskIds.push(errorTaskId);
                }
            }
            
            completeRegistration() {
                const elements = this.getElements();
                const formData = this.formData;
                
                const fetchWithTimeout = (url, options, timeout = 30000) => {
                    return Promise.race([
                        fetch(url, options),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Request timed out')), timeout)
                        )
                    ]);
                };
                
                const registerUser = async () => {
                    try {
                        const response = await fetchWithTimeout(
                            "https://bullion-fx-server.onrender.com/api/v1/user/register",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    username: `${formData.get('firstname')}${formData.get('lastname')}`.toLowerCase(),
                                    fullname: `${formData.get('firstname')} ${formData.get('lastname')}`,
                                    email: formData.get('email'),
                                    phoneNumber: formData.get('phone') || '',
                                    password: formData.get('password'),
                                }),
                            }
                        );
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            localStorage.setItem("user", JSON.stringify(data.data));
                            elements.otpError.textContent = "Registration successful! Redirecting to dashboard...";
                            elements.otpError.classList.add('success');
                            
                            const redirectTaskId = scheduleTask(() => {
                                window.location.href = 'dashboard.html';
                            }, 1500);
                            this.taskIds.push(redirectTaskId);
                        } else {
                            this.handleRegistrationError(data);
                        }
                    } catch (error) {
                        console.error("Error:", error);
                        this.hideModal();
                        
                        const submitButton = document.getElementById("registerSubmitBtn");
                        submitButton.disabled = false;
                        
                        showToast("An error occurred. Please try again later.");
                    }
                };
                
                const registerTaskId = scheduleTask(registerUser);
                this.taskIds.push(registerTaskId);
            }
            
            handleRegistrationError(response) {
                this.hideModal();
                
                const submitButton = document.getElementById("registerSubmitBtn");
                submitButton.disabled = false;
                
                let errorMessage = "Registration failed. Please try again.";
                if (response.message) {
                    errorMessage = response.message;
                }
                
                showToast(errorMessage);
            }
        }

        // Initialize OTP verification
        let otpVerification;
        scheduleTask(() => {
            otpVerification = new OptimizedOTPVerification();
        });

        // Handle form submission
        window.handleRegister = function(e) {
            e.preventDefault();
            
            document.getElementById("registerErrorMessage").textContent = '';
            
            scheduleTask(() => {
                const form = e.target;
                const formData = new FormData(form);
                
                const password = formData.get('password');
                const confirmPassword = formData.get('confirm_password');
                
                if (password !== confirmPassword) {
                    showToast("Confirm Password and password do not match");
                    return;
                }
                
                const email = formData.get('email');
                
                scheduleTask(() => {
                    otpVerification.showModal(email, formData);
                });
            });
        };
    </script>
</body>
</html>